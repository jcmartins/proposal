# Proposal: Token Substitution

Author(s): Simon Plourde

Last updated: 2017-12-08

Discussion at https://github.com/sensu/sensu-go/issues/583.

## Abstract

Use Go's template package to provide token substitution in Sensu 2.

## Background

The attribute placeholders used in Sensu v1 (e.g. `:::mysql.host:::`) would
require significant amount of work in Sensu v2 in order to be supported since Go
doesn't offer support that format natively.

## Proposal

The proposed change consist of replacing the Sensu v1 placeholders with the [Go
Template](https://golang.org/pkg/text/template/) format. Doing so would allow us
to profit from the templating engine in Go's standard library, which is used by
various tools such as Consul Template and Kubernetes.

#### Tokens Syntax

The placeholders for tokens would use the following syntax:

```
$ sensuctl check create check_token
? Command: echo {{ .ID }}
```

#### Generating textual output

Using that previous example, the textual output for the command of a check could
be generated by the agent simply like this:

```
// Parse the command template
commandTmpl := template.New("command")
commandTmpl, _ := commandTmpl.Parse(checkConfig.Command)

// Execute the template and store the output
var buf bytes.Buffer
_ = commandTmpl.Execute(&buf, a.getAgentEntity())

// Assign the textual ouput of that command
checkConfig.Command = buf.String()
```

#### Token substitution default values

Unfortunately the templating engine does not offer support for default values,
however it's relatively easily achievable by declaring a template function. For
example, Consul Template offers a
[keyOrDefault](https://github.com/hashicorp/consul-template#keyexists) function.

#### Unmatched tokens

Again, the templating engine does not offer that functionality but it could also
be done using a template function, such as
[keyExists](https://github.com/hashicorp/consul-template#keyexists) in Consul
Template.

#### Custom attributes in tokens

This is currently a big unknown and I'm not entirely sure how we can support
that, but I assume there's something we can do with template functions. It would
definitively require a PoC.

## Rationale

The only other approach I can see to this problem would be to misuse the
`string.Replace` function or the `regexp` package in conjunction with the
dynamic package but I'm not even sure that would work. Additionally, it would
require an enormous amount of work to catch all edge cases that the template
package has already considered in their parsing.

## Compatibility

This proposal constitutes a breaking change since the syntax of these tokens is
changed. That being said, the path to entities attributes would necessarily
change in v2 so I don't think an automated migration tool for check tokens would
easily be achievable even if we kept the same syntax.

## Implementation

Issues to be created upon approval:

1. Proof of concept with custom attributes.
2. Create an utility for token substitution.
3. Implement token substitution in the agent.
4. Implement token substitution default values.
5. Implement unmatched tokens support.
6. Implement custom attributes support.
